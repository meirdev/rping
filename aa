

extern crate pnet;

use pnet::datalink::{self, NetworkInterface};
use pnet::datalink::Channel::Ethernet;
use pnet::packet::{Packet, MutablePacket};
use pnet::packet::ethernet::{EthernetPacket, MutableEthernetPacket};
use pnet::util::MacAddr;

use std::env;

// Invoke as echo <interface name>
fn main() {
    let interface_name = env::args().nth(1).unwrap();
    let interface_names_match =
        |iface: &NetworkInterface| iface.name == interface_name;

    // Find the network interface with the provided name
    let interfaces = datalink::interfaces();
    let interface = interfaces.into_iter()
                              .filter(interface_names_match)
                              .next()
                              .unwrap();

    

    let mut packet = [0u8;  60];

    let mut eth_mut = MutableEthernetPacket::new(&mut packet).unwrap();
    eth_mut.set_source(interface.mac.unwrap());
    eth_mut.set_destination(MacAddr::broadcast());
    eth_mut.set_ethertype(pnet::packet::ethernet::EtherTypes::Arp);

    let mut arp_request = pnet::packet::arp::MutableArpPacket::new(eth_mut.payload_mut()).unwrap();
    arp_request.set_protocol_type(pnet::packet::ethernet::EtherTypes::Ipv4);
    arp_request.set_hardware_type(pnet::packet::arp::ArpHardwareTypes::Ethernet);
    arp_request.set_operation(pnet::packet::arp::ArpOperations::Request);
    arp_request.set_sender_hw_addr(interface.mac.unwrap());
    arp_request.set_sender_proto_addr(std::net::Ipv4Addr::new(0, 0, 0, 0));
    arp_request.set_target_hw_addr(MacAddr::zero());
    arp_request.set_target_proto_addr(std::net::Ipv4Addr::new(8, 8, 8, 8));

    println!("Sending ARP request on interface: {}", interface.name);
    println!("ARP Request: {:?}", arp_request);
    
    // Create a new channel, dealing with layer 2 packets
    let (mut tx, mut rx) = match datalink::channel(&interface, Default::default()) {
        Ok(Ethernet(tx, rx)) => (tx, rx),
        Ok(_) => panic!("Unhandled channel type"),
        Err(e) => panic!("An error occurred when creating the datalink channel: {}", e)
    };

    // Send the ARP request
    let res = tx.send_to(&packet, None).unwrap();

    println!("Sent {:#?} bytes", res);

    loop {
        match rx.next() {
            Ok(packet) => {
                let eth_packet = EthernetPacket::new(packet).unwrap();
                if eth_packet.get_ethertype() == pnet::packet::ethernet::EtherTypes::Arp {
                    let arp_packet = pnet::packet::arp::ArpPacket::new(eth_packet.payload()).unwrap();
                    if arp_packet.get_operation() == pnet::packet::arp::ArpOperations::Reply {
                        println!("Received ARP reply: {:?}", arp_packet);
                        break;
                    }
                }
            },
            Err(e) => {
                eprintln!("An error occurred while receiving packets: {}", e);
                break;
            }
        }
    }

}